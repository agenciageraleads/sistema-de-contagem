import { SankhyaClient } from '../src/sankhya/sankhya.client';
import { ConfigService } from '@nestjs/config';
import { Logger } from '@nestjs/common';

/**
 * Script para investigar configura√ß√£o do TOP 1121
 * Uso: npx ts-node scripts/investigate-top-1121.ts
 */

async function main() {
    const logger = new Logger('InvestigateTOP');

    // Configurar cliente Sankhya
    const configService = new ConfigService();
    const sankhyaClient = new SankhyaClient(configService, logger);

    try {
        logger.log('üîç Investigando configura√ß√£o do TOP 1121...\n');

        // 1. Buscar configura√ß√£o completa do TOP 1121
        logger.log('1Ô∏è‚É£ Configura√ß√£o do TOP 1121:');
        const top1121 = await sankhyaClient.executeQuery(`
            SELECT *
            FROM TGFTOP
            WHERE CODTIPOPER = 1121
        `);
        console.log(JSON.stringify(top1121, null, 2));
        console.log('\n');

        // 2. Comparar com TOP 221 (que funciona)
        logger.log('2Ô∏è‚É£ Compara√ß√£o TOP 221 vs 1121:');
        const comparison = await sankhyaClient.executeQuery(`
            SELECT 
                CODTIPOPER,
                DESCROPER,
                TIPMOV,
                USAPRECOBASE,
                VALIDAPRECO,
                BLOQPRECOZERADO
            FROM TGFTOP
            WHERE CODTIPOPER IN (221, 1121)
            ORDER BY CODTIPOPER
        `);
        console.table(comparison);
        console.log('\n');

        // 3. Buscar TOPs alternativos de sa√≠da sem valida√ß√£o
        logger.log('3Ô∏è‚É£ TOPs de Sa√≠da sem valida√ß√£o de pre√ßo:');
        const alternatives = await sankhyaClient.executeQuery(`
            SELECT 
                CODTIPOPER,
                DESCROPER,
                TIPMOV
            FROM TGFTOP
            WHERE TIPMOV = 'V'
              AND ATIVO = 'S'
              AND ROWNUM <= 10
            ORDER BY CODTIPOPER
        `);
        console.table(alternatives);
        console.log('\n');

        // 4. Verificar estrutura da tabela TGFTOP
        logger.log('4Ô∏è‚É£ Colunas da tabela TGFTOP:');
        const columns = await sankhyaClient.executeQuery(`
            SELECT COLUMN_NAME, DATA_TYPE, NULLABLE
            FROM USER_TAB_COLUMNS
            WHERE TABLE_NAME = 'TGFTOP'
              AND COLUMN_NAME LIKE '%PRECO%'
            ORDER BY COLUMN_ID
        `);
        console.table(columns);

        logger.log('\n‚úÖ Investiga√ß√£o conclu√≠da!');
        logger.log('\nüìã Pr√≥ximos passos:');
        logger.log('1. Analise as diferen√ßas entre TOP 221 e 1121');
        logger.log('2. Identifique campos relacionados a valida√ß√£o de pre√ßo');
        logger.log('3. Ajuste via interface Sankhya ou SQL (veja docs/tasks/ajustar_top_1121.md)');

    } catch (error) {
        logger.error('‚ùå Erro na investiga√ß√£o:', error);
        throw error;
    }
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });
